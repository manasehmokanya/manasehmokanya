{"version":3,"file":"index.js","sources":["../src/serviceworker.js","../src/loader-error.js","../src/index.js"],"sourcesContent":["\nexport default function serviceWorker(publicPath, file) {\n\treturn `\n\nexport class ServiceWorkerNoSupportError extends Error {\n\n\tconstructor() {\n\t\tsuper('ServiceWorker is not supperted.');\n\t}\n}\n\nexport default function registerServiceWorkerIfSupported(options) {\n\n\tif ('serviceWorker' in navigator) {\n\t\treturn navigator.serviceWorker.register(${publicPath} + ${file}, options);\n\t}\n\n\treturn Promise.reject(new ServiceWorkerNoSupportError());\n}\n\n`;\n}\n","\nexport default class LoaderError extends Error {\n\n\tconstructor(err) {\n\n\t\tsuper(err);\n\n\t\tthis.name = err.name || 'Loader Error';\n\t\tthis.message = `${err.name}\\n\\n${err.message}\\n`;\n\t\tthis.stack = false;\n\t}\n}\n","import path from 'path';\nimport loaderUtils from 'loader-utils';\nimport validateOptions from 'schema-utils';\nimport SingleEntryPlugin from 'webpack/lib/SingleEntryPlugin';\nimport WebWorkerTemplatePlugin from 'webpack/lib/webworker/WebWorkerTemplatePlugin';\nimport getServiceWorker from './serviceworker';\nimport LoaderError from './loader-error';\nimport schema from './options.json';\n\nexport default function loader() {\n}\n\nloader.pitch =\nfunction pitch(request) {\n\n\tconst options = loaderUtils.getOptions(this) || {};\n\n\tvalidateOptions(schema, options, 'ServiceWorker Loader');\n\n\tif (!this.webpack) {\n\t\tthrow new LoaderError({\n\t\t\tname:    'ServiceWorker Loader',\n\t\t\tmessage: 'This loader is only usable with webpack'\n\t\t});\n\t}\n\n\tthis.cacheable(false);\n\n\tconst cb = this.async();\n\n\tconst filename = loaderUtils.interpolateName(this, options.filename || '[name].js', {\n\t\tcontext: options.context || this.rootContext || this.options.context,\n\t\tregExp:  options.regExp\n\t});\n\n\tconst publicPath = options.publicPath || '/';\n\n\tconst outputOptions = {\n\t\tfilename,\n\t\tchunkFilename:      `[id].${filename}`,\n\t\tnamedChunkFilename: null\n\t};\n\n\t// TODO remove and triage eventual replacement via an option if needed\n\t// doesn't work with webpack > v2.0.0\n\tif (this.options && this.options.worker && this.options.worker.output) {\n\t\tObject.keys(this.options.worker.output).forEach((name) => {\n\t\t\toutputOptions[name] = this.options.worker.output[name];\n\t\t});\n\t}\n\n\tconst compiler = this._compilation.createChildCompiler('service-worker', outputOptions);\n\n\tcompiler.apply(new WebWorkerTemplatePlugin(outputOptions));\n\tcompiler.apply(new SingleEntryPlugin(this.context, `!!${request}`, 'main'));\n\n\t// TODO remove and triage eventual replacement via an option if needed\n\t// doesn't work with webpack > v2.0.0\n\tif (this.options && this.options.worker && this.options.worker.plugins) {\n\t\tthis.options.worker.plugins.forEach(plugin =>\n\t\t\tcompiler.apply(plugin)\n\t\t);\n\t}\n\n\tconst subCache = `subcache ${__dirname} ${request}`;\n\n\tcompiler.plugin('compilation', (compilation) => {\n\n\t\tif (compilation.cache) {\n\n\t\t\tif (!compilation.cache[subCache]) {\n\t\t\t\tcompilation.cache[subCache] = {};\n\t\t\t}\n\n\t\t\tcompilation.cache = compilation.cache[subCache];\n\t\t}\n\t});\n\n\tconst rootCompiler = this._compiler,\n\t\tfs = rootCompiler.outputFileSystem;\n\n\tcompiler.runAsChild((err, entries) => {\n\n\t\tif (err) {\n\t\t\treturn cb(err);\n\t\t}\n\n\t\tif (entries[0]) {\n\n\t\t\tconst file = entries[0].files[0];\n\n\t\t\tif (options.outputPath) {\n\n\t\t\t\trootCompiler.plugin('after-emit', (compilation, callback) => {\n\n\t\t\t\t\tconst asset = compilation.assets[file];\n\n\t\t\t\t\tfs.unlink(asset.existsAt, (err) => {\n\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\treturn callback(err);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn fs.writeFile(path.join(options.outputPath, file), asset.source(), 'utf8', err =>\n\t\t\t\t\t\t\tcallback(err)\n\t\t\t\t\t\t);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst code = getServiceWorker(\n\t\t\t\tJSON.stringify(publicPath) || '__webpack_public_path__',\n\t\t\t\tJSON.stringify(file)\n\t\t\t);\n\n\t\t\treturn cb(null, code);\n\t\t}\n\n\t\treturn cb(null, null);\n\t});\n};\n"],"names":["serviceWorker","publicPath","file","LoaderError","Error","err","name","message","stack","loader","pitch","request","options","loaderUtils","getOptions","schema","webpack","cacheable","cb","async","filename","interpolateName","context","rootContext","regExp","outputOptions","worker","output","keys","forEach","compiler","_compilation","createChildCompiler","apply","WebWorkerTemplatePlugin","SingleEntryPlugin","plugins","plugin","subCache","__dirname","compilation","cache","rootCompiler","_compiler","fs","outputFileSystem","runAsChild","entries","files","outputPath","callback","asset","assets","unlink","existsAt","writeFile","path","join","source","code","getServiceWorker","JSON","stringify"],"mappings":"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"}